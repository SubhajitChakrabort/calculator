<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCLD Staging Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'calc-bg': '#000000',
                        'calc-display': '#1c1c1e',
                        'calc-button': '#333333',
                        'calc-button-light': '#a5a5a5',
                        'calc-button-orange': '#ff9f0a',
                        'calc-button-dark': '#1c1c1e'
                    },
                    boxShadow: {
                        'button': '0 2px 4px rgba(0, 0, 0, 0.3)',
                        'button-active': 'inset 0 2px 4px rgba(0, 0, 0, 0.5)',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .cursor-blink::after {
            content: '|';
            animation: blink 1s infinite;
            color: #06b6d4;
        }
        
        .calc-button {
            @apply transition-all duration-150 ease-out;
            min-height: 17px; /* Reduced by 50% from 34px */
            aspect-ratio: 1;
            border-radius: 50%;
            font-weight: 400;
            letter-spacing: -0.5px;
        }
        
        .calc-button:active {
            transform: scale(0.95);
        }
        
        .calc-button-gray {
            background: linear-gradient(145deg, #333333, #2a2a2a);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .calc-button-gray:active {
            background: linear-gradient(145deg, #2a2a2a, #333333);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .calc-button-light {
            background: linear-gradient(145deg, #a5a5a5, #8a8a8a);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .calc-button-light:active {
            background: linear-gradient(145deg, #8a8a8a, #a5a5a5);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .calc-button-orange {
            background: linear-gradient(145deg, #ff9f0a, #e68a00);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .calc-button-orange:active {
            background: linear-gradient(145deg, #e68a00, #ff9f0a);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .calc-button-orange.selected {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            color: #ff9f0a;
        }
        
        @media (max-width: 640px) {
            .calc-button {
                min-height: 15px; /* Reduced by 50% from 29px */
            }
        }
        
        @media (max-width: 480px) {
            .calc-button {
                min-height: 14px; /* Reduced by 50% from 27px */
            }
        }
        
        /* Additional responsive breakpoint for 375px width */
        @media (max-width: 375px) {
            .calc-button {
                min-height: 11px; /* Reduced by 50% from 22px */
            }
            
            /* Reduce gap between buttons */
            .grid.grid-cols-4 {
                gap: 0.0625rem; /* Reduced from 0.125rem */
            }
            
            /* Reduce padding around calculator */
            .px-4 {
                padding-left: 0.0625rem;
                padding-right: 0.0625rem;
            }
            
            .pb-4 {
                padding-bottom: 0.0625rem;
            }
            
            /* Reduce display padding */
            .bg-calc-display {
                padding: 0.125rem; /* Reduced from 0.25rem */
            }
            
            /* Reduce margin below display */
            .mb-6 {
                margin-bottom: 0.125rem; /* Reduced from 0.25rem */
            }
            
            /* Move buttons up with relative positioning */
            .flex-shrink-0.pb-4 {
                position: relative;
                top: -2rem;
            }
        }
        
        /* Additional breakpoint for screens smaller than 322px */
        @media (max-width: 322px) {
            .calc-button {
                min-height: 10px; /* Reduced by 50% from 19px */
                border-radius: 2px; /* Smaller rounded corners */
            }
            
            /* Reduce gap between buttons even more */
            .grid.grid-cols-4 {
                gap: 0.03125rem; /* Further reduced gap */
            }
            
            /* Reduce padding around calculator */
            .px-4 {
                padding-left: 0.03125rem;
                padding-right: 0.03125rem;
            }
            
            .pb-4 {
                padding-bottom: 0.03125rem;
            }
            
            /* Reduce display padding */
            .bg-calc-display {
                padding: 0.0625rem; /* Further reduced padding */
            }
            
            /* Reduce margin below display */
            .mb-6 {
                margin-bottom: 0.0625rem; /* Further reduced margin */
            }
            
            /* Reduce font sizes for buttons */
            .calc-button {
                font-size: 0.25rem !important; /* Smaller font size */
            }
            
            /* Move buttons up more with relative positioning */
            .flex-shrink-0.pb-4 {
                position: relative;
                top: -2.5rem;
            }
        }
        
        /* Additional breakpoint for very small screens */
        @media (max-width: 280px) {
            .calc-button {
                min-height: 9px; /* Reduced by 50% from 17px */
                border-radius: 1px; /* Smaller rounded corners */
            }
            
            /* Reduce gap between buttons even more */
            .grid.grid-cols-4 {
                gap: 0.015625rem; /* Very small gap */
            }
            
            /* Reduce padding around calculator */
            .px-4 {
                padding-left: 0.015625rem;
                padding-right: 0.015625rem;
            }
            
            .pb-4 {
                padding-bottom: 0.015625rem;
            }
            
            /* Reduce display padding */
            .bg-calc-display {
                padding: 0.03125rem; /* Very small padding */
            }
            
            /* Reduce margin below display */
            .mb-6 {
                margin-bottom: 0.03125rem; /* Very small margin */
            }
            
            /* Reduce font sizes for buttons */
            .calc-button {
                font-size: 0.1875rem !important; /* Even smaller font size */
            }
            
            /* Move buttons up even more with relative positioning */
            .flex-shrink-0.pb-4 {
                position: relative;
                top: -3rem;
            }
        }
    </style>
</head>

<body class="bg-calc-bg m-0 p-0 h-screen w-screen overflow-hidden">
    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-calc-display rounded-3xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-hidden">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b border-gray-700">
                <h2 class="text-white text-xl font-semibold">Calculation History</h2>
                <button id="closeHistoryBtn" class="text-white hover:text-red-400 text-2xl font-bold w-10 h-10 flex items-center justify-center rounded-full hover:bg-red-500/20 transition-all">
                    ×
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6 max-h-96 overflow-y-auto">
                <div id="fullHistoryList" class="space-y-3">
                    <div class="text-gray-400 text-center">No calculations yet</div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-700">
                <button id="clearHistoryBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-2xl transition-all">
                    Clear All History
                </button>
            </div>
        </div>
    </div>

    <div class="h-screen w-full bg-calc-bg flex flex-col">
        <!-- Made at RCLD Text -->
        <div class="text-center pt-4 pb-2 flex-shrink-0">
            <h1 class="text-white/60 text-sm font-medium tracking-wide">Made at RCLD Islampur</h1>
        </div>

        <!-- Display Screen -->
        <div class="flex-1 flex flex-col justify-end px-4 pb-4">
            <div class="bg-calc-display rounded-3xl p-6 mb-6">
                <!-- Input Display Section (White Text) -->
                <div class="relative mb-4 flex-shrink-0">
                    <div id="inputDisplay"
                        class="w-full min-h-12 bg-transparent text-white text-right font-light tracking-wide leading-tight"
                        style="transition: font-size 0.2s;">
                    </div>
                </div>

                <!-- Result Display Section (Orange Text) -->
                <div class="relative flex-1 flex items-end justify-end min-h-0">
                    <div id="result"
                        class="w-full bg-transparent text-orange-400 text-right font-bold tracking-wide flex items-end justify-end leading-none"
                        style="transition: font-size 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                    </div>
                </div> 
            </div>

            <!-- Calculator Buttons Container -->
            <div class="flex-shrink-0 pb-4">
                <!-- Main Button Grid -->
                <div class="grid grid-cols-4 gap-4 w-full max-w-sm mx-auto">

                    <!-- First Row: ⋯, ⌫, AC, % -->
                    <button id="historyBtn"
                        class="calc-button calc-button-light text-black text-2xl font-medium">
                        ⋯
                    </button>
                    <button
                        class="calc-button calc-button-light text-black text-2xl font-medium">⌫</button>
                    <button
                        class="calc-button calc-button-light text-black text-2xl font-medium">AC</button>
                    <button
                        class="calc-button calc-button-orange text-white text-2xl font-medium">%</button>

                    <!-- Second Row: ( ) √ ÷ -->
                    <button
                        class="calc-button calc-button-light text-black text-2xl font-medium">(</button>
                    <button
                        class="calc-button calc-button-light text-black text-2xl font-medium">)</button>
                    <button
                        class="calc-button calc-button-light text-black text-2xl font-medium"
                        data-value="√">√</button>
                    <button
                        class="calc-button calc-button-orange text-white text-3xl font-medium flex items-center justify-center"
                        data-value="/">
                        <span class="text-3xl">÷</span>
                    </button>

                    <!-- Third Row: 7 8 9 × -->
                    <button
                        class="calc-button calc-button-gray text-white text-2xl font-medium">7</button>
                    <button
                        class="calc-button calc-button-gray text-white text-2xl font-medium">8</button>
                    <button
                        class="calc-button calc-button-gray text-white text-2xl font-medium">9</button>
                    <button
                        class="calc-button calc-button-orange text-white text-3xl font-medium">×</button>

                    <!-- Fourth Row: 4 5 6 - -->
                    <button
                        class="calc-button calc-button-gray text-white text-2xl font-medium">4</button>
                    <button
                        class="calc-button calc-button-gray text-white text-2xl font-medium">5</button>
                    <button
                        class="calc-button calc-button-gray text-white text-2xl font-medium">6</button>
                    <button
                        class="calc-button calc-button-orange text-white text-3xl font-medium">−</button>

                    <!-- Fifth Row: 1 2 3 + -->
                    <button
                        class="calc-button calc-button-gray text-white text-2xl font-medium">1</button>
                    <button
                        class="calc-button calc-button-gray text-white text-2xl font-medium">2</button>
                    <button
                        class="calc-button calc-button-gray text-white text-2xl font-medium">3</button>
                    <button
                        class="calc-button calc-button-orange text-white text-3xl font-medium">+</button>

                    <!-- Sixth Row: +/- 0 . = -->
                    <button
                        class="calc-button calc-button-gray text-white text-xl font-medium">+/-</button>
                    <button
                        class="calc-button calc-button-gray text-white text-2xl font-medium">0</button>
                    <button
                        class="calc-button calc-button-gray text-white text-2xl font-medium">.</button>
                    <button
                        class="calc-button calc-button-orange text-white text-3xl font-medium">=</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const inputDisplay = document.getElementById('inputDisplay');
        const result = document.getElementById('result');
        const buttons = document.querySelectorAll('.calc-button');
        const historyModal = document.getElementById('historyModal');
        const historyBtn = document.getElementById('historyBtn');
        const closeHistoryBtn = document.getElementById('closeHistoryBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const fullHistoryList = document.getElementById('fullHistoryList');
        
        let currentInput = '';
        let calculations = [];
        let shouldResetOnNextNumber = false;
        let lastResult = null;
        let justCalculated = false;
        let isCalculating = false;

        // Function to format input with line breaks every 8 digits
        function formatInputWithLineBreaks(input) {
            if (!input) return '';
            
            // Split the input into parts (numbers and operators)
            const parts = input.split(/([+\-×/*()√])/);
            let formattedParts = [];
            
            for (let part of parts) {
                if (part && !['+', '-', '×', '/', '*', '(', ')', '√'].includes(part)) {
                    // This is a number, add line breaks every 8 digits
                    let formattedNumber = '';
                    for (let i = 0; i < part.length; i++) {
                        if (i > 0 && i % 8 === 0) {
                            formattedNumber += '<br>';
                        }
                        formattedNumber += part[i];
                    }
                    formattedParts.push(formattedNumber);
                } else if (part) {
                    // This is an operator or special character - keep it white
                    formattedParts.push(part);
                }
            }
            
            return formattedParts.join('');
        }

        // Function to update input display with line breaks
        function updateInputDisplay() {
            inputDisplay.innerHTML = formatInputWithLineBreaks(currentInput);
        }

        // Function to format large numbers in scientific notation
        function formatLargeNumber(num) {
            const numStr = num.toString();
            if (numStr.length >= 15) {
                return parseFloat(num).toExponential(6);
            }
            return num;
        }

        // Function to clear input display
        function clearInputDisplay() {
            inputDisplay.innerHTML = '';
        }

        // LocalStorage functions
        function saveCalculationsToStorage() {
            try {
                localStorage.setItem('calculatorHistory', JSON.stringify(calculations));
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        function loadCalculationsFromStorage() {
            try {
                const saved = localStorage.getItem('calculatorHistory');
                if (saved) {
                    calculations = JSON.parse(saved);
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                calculations = [];
            }
        }

        function clearCalculationsFromStorage() {
            try {
                localStorage.removeItem('calculatorHistory');
            } catch (error) {
                console.error('Error clearing localStorage:', error);
            }
        }

        // Function to format decimal numbers to maximum 6 decimal places
        function formatResult(num) {
            if (typeof num !== 'number' || !isFinite(num)) {
                return num;
            }
            
            // If it's a whole number, return as is
            if (num % 1 === 0) {
                return num;
            }
            
            // For decimal numbers, limit to 6 decimal places and remove trailing zeros
            const formatted = parseFloat(num.toFixed(6));
            return formatted;
        }

        // Function to format result with line breaks every 8 digits
        function formatResultWithLineBreaks(result) {
            if (!result || result === '') return '';
            
            const resultStr = result.toString();
            let formattedResult = '';
            
            for (let i = 0; i < resultStr.length; i++) {
                if (i > 0 && i % 8 === 0) {
                    formattedResult += '<br>';
                }
                formattedResult += resultStr[i];
            }
            
            return formattedResult;
        }

        // Function to format result with white operators
        function formatResultWithWhiteOperators(result) {
            if (!result || result === '') return '';
            
            const resultStr = result.toString();
            // Replace operators with white-colored spans
            let formattedResult = resultStr
                .replace(/([+\-×/*()√])/g, '<span style="color: white;">$1</span>');
            
            return formattedResult;
        }

        function updateFullHistoryDisplay() {
            if (calculations.length === 0) {
                fullHistoryList.innerHTML = '<div class="text-gray-400 text-center">No calculations yet</div>';
            } else {
                // Show only the last 3 calculations (most recent first)
                const recentCalculations = calculations.slice(-3).reverse();
                fullHistoryList.innerHTML = recentCalculations.map((calc, index) => 
                    `<div class="bg-gray-800/50 rounded-2xl p-4 border border-gray-700">
                        <div class="text-white font-light text-sm mb-2">${calc.input}</div>
                        <div class="text-white font-semibold text-lg">= ${calc.result}</div>
                        <div class="text-gray-500 text-xs mt-2">Recent calculation ${index + 1}</div>
                    </div>`
                ).join('');
            }
        }

        function isValidInput(current, newValue) {
            if (newValue === '.') {
                const numbers = current.split(/[+\-×/*]/);
                const currentNumber = numbers[numbers.length - 1];
                if (currentNumber.includes('.')) return false;
            }

            if (['+', '-', '×', '/'].includes(newValue)) {
                const lastChar = current.slice(-1);
                if (['+', '-', '×', '/', '*'].includes(lastChar)) return false;
            }

            return true;
        }

        function evaluateExpression(expr) {
            try {
                // Handle square root
                expr = expr.replace(/√(\d+\.?\d*)/g, 'Math.sqrt($1)');
                // Handle implicit multiplication like 5(5+6) -> 5*(5+6)
                expr = expr.replace(/(\d)\(/g, '$1*(');
                expr = expr.replace(/\)(\d)/g, ')*$1');
                expr = expr.replace(/×/g, '*');
                
                const rawResult = eval(expr);
                return formatResult(rawResult);
            } catch (error) {
                return 'Error';
            }
        }

        // Function to update result display with line breaks
        function updateResultDisplay(value) {
            result.innerHTML = value;
        }

        // Function to dynamically set result font size based on length
        function setResultFontSize(value) {
            const len = value.toString().length;
            let fontSize = '';
            if (len <= 7) {
                fontSize = '2.5rem'; // reduced from 3.5rem (about 0.7x)
            } else if (len <= 12) {
                fontSize = '1.8rem'; // reduced from 2.5rem (about 0.7x)
            } else if (len <= 18) {
                fontSize = '1.3rem'; // reduced from 1.8rem (about 0.7x)
            } else {
                fontSize = '0.9rem'; // reduced from 1.2rem (about 0.75x)
            }
            result.style.fontSize = fontSize;
        }

        // Function to dynamically set input font size based on length
        function setInputFontSize(value) {
            const len = value.toString().length;
            let fontSize = '';
            if (len <= 7) {
                fontSize = '2.5rem'; // same as result display
            } else if (len <= 12) {
                fontSize = '1.8rem'; // same as result display
            } else if (len <= 18) {
                fontSize = '1.3rem'; // same as result display
            } else {
                fontSize = '0.9rem'; // same as result display
            }
            inputDisplay.style.fontSize = fontSize;
        }

        // Function to control cursor blinking
        function setCursorBlinking(show) {
            if (show) {
                result.classList.add('cursor-blink');
            } else {
                result.classList.remove('cursor-blink');
            }
        }

        // Update updateLiveCalculation to use setResultFontSize
        function updateLiveCalculation() {
            try {
                if (currentInput && currentInput !== '') {
                    // Only show live calculation if there's an operator and we're not in the middle of typing a number
                    const hasOperator = /[+\-×/*√]/.test(currentInput);
                    const endsWithOperator = /[+\-×/*]$/.test(currentInput);

                    if (hasOperator && !endsWithOperator) {
                        const tempResult = evaluateExpression(currentInput);
                        if (tempResult !== 'Error' && !isNaN(tempResult) && isFinite(tempResult)) {
                            updateResultDisplay(tempResult);
                            setResultFontSize(tempResult);
                            lastResult = tempResult;
                            shouldResetOnNextNumber = false;
                        } else {
                            updateResultDisplay('');
                            setResultFontSize('');
                            shouldResetOnNextNumber = false;
                        }
                    } else {
                        // Don't show anything in result display while typing
                        updateResultDisplay('');
                        setResultFontSize('');
                        shouldResetOnNextNumber = false;
                    }
                } else {
                    updateResultDisplay('');
                    setResultFontSize('');
                    shouldResetOnNextNumber = false;
                }
            } catch {
                updateResultDisplay('');
                setResultFontSize('');
                shouldResetOnNextNumber = false;
            }
        }

        function isOperator(value) {
            return ['+', '-', '×', '/', '*', '√'].includes(value);
        }

        function isNumber(value) {
            return /^[0-9]$/.test(value);
        }

        function replaceLastOperator(input, newOperator) {
            if (!input) return input;
            const lastChar = input.slice(-1);
            if (isOperator(lastChar)) {
                return input.slice(0, -1) + (newOperator === '×' ? '*' : newOperator);
            }
            return input;
        }

        // History Modal Event Listeners
        historyBtn.addEventListener('click', () => {
            updateFullHistoryDisplay();
            historyModal.classList.remove('hidden');
        });

        closeHistoryBtn.addEventListener('click', () => {
            historyModal.classList.add('hidden');
        });

        clearHistoryBtn.addEventListener('click', () => {
            calculations = [];
            clearCalculationsFromStorage();
            updateFullHistoryDisplay();
        });

        // Close modal when clicking outside
        historyModal.addEventListener('click', (e) => {
            if (e.target === historyModal) {
                historyModal.classList.add('hidden');
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !historyModal.classList.contains('hidden')) {
                historyModal.classList.add('hidden');
            }
        });

        buttons.forEach(button => {
            button.addEventListener('click', () => {
                let actualValue = button.getAttribute('data-value') || button.textContent.trim();

                // Skip if it's the history button
                if (button.id === 'historyBtn') {
                    return;
                }

                switch (actualValue) {
                    case 'AC':
                        currentInput = '';
                        result.textContent = '';
                        clearInputDisplay(); // Clear the white input text
                        shouldResetOnNextNumber = false;
                        lastResult = null;
                        justCalculated = false;
                        isCalculating = false;
                        setCursorBlinking(true);
                        break;

                    case '⌫':
                        if (justCalculated) {
                            currentInput = '';
                            justCalculated = false;
                            clearInputDisplay(); // Clear the white input text
                        } else {
                            currentInput = currentInput.slice(0, -1);
                        }
                        shouldResetOnNextNumber = false;
                        isCalculating = false;
                        setCursorBlinking(true);
                        updateLiveCalculation();
                        updateInputDisplay(); // Update input display
                        break;

                    case '=':
                        try {
                            if (currentInput) {
                                isCalculating = true;
                                setCursorBlinking(false);
                                const finalResult = evaluateExpression(currentInput);
                                if (finalResult !== 'Error' && !isNaN(finalResult) && isFinite(finalResult)) {
                                    calculations.push({
                                        input: currentInput,
                                        result: finalResult,
                                        timestamp: new Date().toLocaleString()
                                    });
                                    saveCalculationsToStorage();
                                    clearInputDisplay(); // Clear the white input text
                                    const formattedResult = formatLargeNumber(finalResult);
                                    result.innerHTML = formatResultWithWhiteOperators(formattedResult);
                                    setResultFontSize(formattedResult);
                                    shouldResetOnNextNumber = true;
                                    lastResult = finalResult;
                                    justCalculated = true;
                                } else {
                                    clearInputDisplay(); // Clear the white input text
                                    result.textContent = 'Error';
                                    setResultFontSize('Error');
                                    currentInput = '';
                                    shouldResetOnNextNumber = false;
                                    justCalculated = false;
                                    isCalculating = false;
                                    setCursorBlinking(true);
                                }
                            }
                        } catch {
                            clearInputDisplay(); // Clear the white input text
                            result.textContent = 'Error';
                            setResultFontSize('Error');
                            currentInput = '';
                            shouldResetOnNextNumber = false;
                            justCalculated = false;
                            isCalculating = false;
                            setCursorBlinking(true);
                        }
                        updateLiveCalculation();
                        break;

                    case '+/-':
                        if (shouldResetOnNextNumber && lastResult !== null) {
                            const negatedResult = formatResult(-lastResult);
                            currentInput = `(${negatedResult})`;
                            shouldResetOnNextNumber = false;
                            justCalculated = false;
                        } else if (currentInput) {
                            const lastNumberMatch = currentInput.match(/-?\d+\.?\d*$/);
                            if (lastNumberMatch) {
                                const lastNumber = lastNumberMatch[0];
                                const newNumber = formatResult(-parseFloat(lastNumber));
                                currentInput = currentInput.replace(/-?\d+\.?\d*$/, `(${newNumber})`);
                            }
                        }
                        updateLiveCalculation();
                        updateInputDisplay(); // Update input display
                        break;

                    case '%':
                        if (shouldResetOnNextNumber && lastResult !== null) {
                            const percentResult = formatResult(lastResult / 100);
                            currentInput = percentResult.toString();
                            shouldResetOnNextNumber = false;
                            justCalculated = false;
                        } else if (currentInput) {
                            try {
                                const percentResult = formatResult(evaluateExpression(currentInput) / 100);
                                currentInput = percentResult.toString();
                            } catch {
                                result.textContent = 'Error';
                                break;
                            }
                        }
                        updateLiveCalculation();
                        updateInputDisplay(); // Update input display
                        break;

                    case '√':
                        if (shouldResetOnNextNumber && lastResult !== null) {
                            if (lastResult >= 0) {
                                const sqrtResult = formatResult(Math.sqrt(lastResult));
                                currentInput = sqrtResult.toString();
                                shouldResetOnNextNumber = false;
                                justCalculated = false;
                            } else {
                                result.textContent = 'Error';
                                currentInput = '';
                                shouldResetOnNextNumber = false;
                                justCalculated = false;
                            }
                        } else {
                            currentInput += '√';
                            shouldResetOnNextNumber = false;
                            justCalculated = false;
                        }
                        updateLiveCalculation();
                        updateInputDisplay(); // Update input display
                        break;

                    default:
                        if (isOperator(actualValue) && actualValue !== '√') {
                            justCalculated = false;
                            isCalculating = true;
                            setCursorBlinking(false);
                            if (shouldResetOnNextNumber && lastResult !== null) {
                                currentInput = lastResult.toString() + (actualValue === '×' ? '*' : actualValue);
                                shouldResetOnNextNumber = false;
                            } else if (currentInput && !isOperator(currentInput.slice(-1))) {
                                currentInput += actualValue === '×' ? '*' : actualValue;
                            } else if (currentInput && isOperator(currentInput.slice(-1))) {
                                currentInput = replaceLastOperator(currentInput, actualValue);
                            }
                            updateLiveCalculation();
                        } else if (isNumber(actualValue) || actualValue === '.') {
                            if (shouldResetOnNextNumber || justCalculated) {
                                // Start a new calculation with the new number
                                currentInput = actualValue;
                                shouldResetOnNextNumber = false;
                                justCalculated = false;
                                isCalculating = true;
                                setCursorBlinking(false);
                                clearInputDisplay(); // Clear the white input text
                            } else {
                                if (isValidInput(currentInput, actualValue)) {
                                    currentInput += actualValue;
                                    if (!isCalculating) {
                                        isCalculating = true;
                                        setCursorBlinking(false);
                                    }
                                }
                                shouldResetOnNextNumber = false;
                                justCalculated = false;
                            }
                            updateLiveCalculation();
                        } else {
                            if (shouldResetOnNextNumber && justCalculated) {
                                if (actualValue === '(') {
                                    currentInput = actualValue;
                                    shouldResetOnNextNumber = false;
                                    justCalculated = false;
                                    isCalculating = true;
                                    setCursorBlinking(false);
                                    clearInputDisplay(); // Clear the white input text
                                }
                            } else {
                                if (isValidInput(currentInput, actualValue)) {
                                    currentInput += actualValue;
                                    if (!isCalculating) {
                                        isCalculating = true;
                                        setCursorBlinking(false);
                                    }
                                }
                                shouldResetOnNextNumber = false;
                                justCalculated = false;
                            }
                            updateLiveCalculation();
                        }
                        updateInputDisplay(); // Update input display
                        break;
                }

                setInputFontSize(currentInput);
            });
        });

        // Initialize - Load saved calculations on page load
        loadCalculationsFromStorage();
        updateLiveCalculation();
        setInputFontSize(currentInput);
        setCursorBlinking(true);
        clearInputDisplay(); // Clear the white input text on page load

        // Prevent scrolling on touch devices
        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });

        // Prevent scrolling with mouse wheel
        document.addEventListener('wheel', function(e) {
            e.preventDefault();
        }, { passive: false });

        // Prevent scrolling with keyboard (but allow Escape for modal)
        document.addEventListener('keydown', function(e) {
            if(['Space', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].indexOf(e.code) > -1) {
                e.preventDefault();
            }
        }, false);
    </script>
</body>

</html>


