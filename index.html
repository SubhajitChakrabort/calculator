<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RCLD Staging Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'calc-bg': '#000000',
                        'display-bg': '#000000',
                        'button-orange': '#FF9500',
                        'button-gray': '#333333',
                        'button-light-gray': '#A5A5A5',
                        'button-dark-gray': '#1C1C1C'
                    },
                    boxShadow: {
                        'button-press': 'inset 0 2px 4px rgba(0, 0, 0, 0.3)',
                        'button-hover': '0 4px 8px rgba(0, 0, 0, 0.3)'
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        .cursor-blink::after {
            content: '|';
            animation: blink 1s infinite;
            color: #FF9500;
        }

        /* Custom scrollbar for history modal */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1C1C1C;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #FF9500;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #FF8000;
        }

        /* Hide scrollbar for display areas */
        #inputExpression::-webkit-scrollbar,
        #result::-webkit-scrollbar {
            display: none;
        }

        /* Button press animation */
        .btn-press {
            transform: scale(0.95);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Smooth transitions */
        .smooth-transition {
            transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Display text gradient */
        .display-gradient {
            background: linear-gradient(135deg, #FFFFFF 0%, #E5E5E5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Button hover effects */
        .calc-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .calc-button:active {
            transform: scale(0.95);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* History sidebar */
        .history-sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            will-change: transform;
        }
        .history-sidebar.open {
            transform: translateX(0);
        }

        /* Responsive font sizes - consistent across all devices */
        .display-text {
            font-size: clamp(1.8rem, 6vw, 3.5rem);
        }
        .button-text {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
        }
        
        /* Input expression and result text sizing */
        #inputExpression {
            font-size: clamp(1.2rem, 4vw, 2rem) !important;
            width: 100% !important;
            max-width: 100% !important;
            text-align: right !important;
            padding-right: 0 !important;
            margin-right: 0 !important;
        }
        
        #result {
            font-size: clamp(1.8rem, 6vw, 3.5rem) !important;
            width: 100% !important;
            max-width: 100% !important;
            text-align: right !important;
            padding-right: 0 !important;
            margin-right: 0 !important;
        }
    </style>
</head>

<body class="bg-calc-bg m-0 p-0 h-screen w-screen overflow-hidden font-sans">
    <!-- History Sidebar -->
    <div id="historySidebar" class="history-sidebar fixed top-0 left-0 h-full w-80 bg-calc-bg border-r border-gray-800 z-50 shadow-2xl">
        <div class="flex flex-col h-full">
            <!-- Sidebar Header -->
            <div class="flex justify-between items-center p-6 border-b border-gray-800">
                <h2 class="text-white text-xl font-semibold">History</h2>
                <button id="closeSidebarBtn" class="text-white hover:text-red-400 text-2xl font-bold w-10 h-10 flex items-center justify-center rounded-full hover:bg-red-500/20 transition-all">
                    ×
                </button>
            </div>
            
            <!-- Sidebar Body -->
            <div class="flex-1 p-6 overflow-y-auto custom-scrollbar">
                <div id="sidebarHistoryList" class="space-y-3">
                    <div class="text-gray-400 text-center">No calculations yet</div>
                </div>
            </div>
            
            <!-- Sidebar Footer -->
            <div class="p-6 border-t border-gray-800">
                <button id="clearSidebarHistoryBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-2xl transition-all flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    <span>Clear History</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Overlay for sidebar -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-30 hidden"></div>

    <!-- History Modal -->
    <div id="historyModal" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-calc-bg rounded-3xl shadow-2xl max-w-md w-full max-h-[85vh] overflow-hidden border border-gray-800">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b border-gray-800">
                <h2 class="text-white text-xl font-semibold">History</h2>
                <button id="closeHistoryBtn" class="text-white hover:text-red-400 text-2xl font-bold w-10 h-10 flex items-center justify-center rounded-full hover:bg-red-500/20 transition-all">
                    ×
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6 max-h-96 overflow-y-auto custom-scrollbar">
                <div id="fullHistoryList" class="space-y-3">
                    <div class="text-gray-400 text-center">No calculations yet</div>
                </div>
            </div>
            
            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-800">
                <button id="clearHistoryBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-2xl transition-all">
                    Clear History
                </button>
            </div>
        </div>
    </div>

    <div class="h-screen w-full bg-calc-bg flex flex-col">
        <!-- Status Bar Area (for mobile) -->
        <div class="flex-shrink-0 h-6 sm:h-8 md:h-10"></div>

        <!-- Made at RCLD Text -->
        <div class="text-center mb-2 sm:mb-4 flex-shrink-0">
            <h1 class="text-white/60 text-sm sm:text-base md:text-lg font-medium tracking-wide">
                Made at RCLD Islampur
            </h1>
        </div>

                        <!-- Display Screen - Dual Display Section -->
        <div class="flex-1 flex flex-col justify-end px-2 sm:px-4 md:px-6 pb-2 sm:pb-4 md:pb-6 min-h-0">
            <div class="bg-display-bg rounded-3xl p-3 sm:p-4 md:p-6 relative h-full flex flex-col">
                <!-- Input Expression Display Section -->
                <div class="relative mb-2 sm:mb-3 flex-shrink-0" style="max-height: 60px; overflow: hidden;">
                    <div id="inputExpression"
                        class="bg-transparent text-white/70 text-right font-light leading-tight"
                        style="transition: font-size 0.2s; word-wrap: break-word; white-space: pre-wrap; transform: translateY(0);">
                    </div>
                </div>

                <!-- Live Calculation Result Display Section -->
                <div class="relative flex-1 flex items-end justify-end min-h-0">
                    <div id="result"
                        class="bg-transparent text-white text-right font-light leading-none"
                        style="transition: font-size 0.2s; word-wrap: break-word; white-space: pre-wrap;">
                    </div>
                </div> 
            </div>
        </div>

        <!-- Calculator Buttons Container -->
        <div class="flex-shrink-0 px-2 sm:px-4 md:px-6 pb-2 sm:pb-4 md:pb-6">
            <!-- Main Button Grid -->
            <div class="grid grid-cols-4 gap-2 sm:gap-3 md:gap-4 w-full max-w-md mx-auto">

                <!-- First Row: ⋯, AC, ⌫, % -->
                <button id="historyBtn"
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-gray text-white rounded-full button-text font-medium smooth-transition flex items-center justify-center"
                    onclick="console.log('Direct onclick triggered'); updateSidebarHistoryDisplay(); document.getElementById('historySidebar').classList.add('open'); document.getElementById('sidebarOverlay').classList.remove('hidden');">
                    <svg class="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-gray text-white rounded-full button-text font-medium smooth-transition">AC</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-gray text-white rounded-full button-text font-medium smooth-transition">⌫</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-orange text-white rounded-full button-text font-medium smooth-transition">%</button>

                <!-- Second Row: ( ) √ ÷ -->
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-gray text-white rounded-full button-text font-medium smooth-transition">(</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-gray text-white rounded-full button-text font-medium smooth-transition">)</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-gray text-white rounded-full button-text font-medium smooth-transition"
                    data-value="√">√</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-orange text-white rounded-full button-text font-medium smooth-transition flex items-center justify-center"
                    data-value="/">
                    <svg class="w-6 h-6 sm:w-7 sm:h-7 md:w-8 md:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle cx="12" cy="8" r="1.5" fill="currentColor"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 12h14"/>
                        <circle cx="12" cy="16" r="1.5" fill="currentColor"/>
                    </svg>
                </button>

                <!-- Third Row: 7 8 9 × -->
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-dark-gray text-white rounded-full button-text font-medium smooth-transition">7</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-dark-gray text-white rounded-full button-text font-medium smooth-transition">8</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-dark-gray text-white rounded-full button-text font-medium smooth-transition">9</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-orange text-white rounded-full button-text font-medium smooth-transition">×</button>

                <!-- Fourth Row: 4 5 6 - -->
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-dark-gray text-white rounded-full button-text font-medium smooth-transition">4</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-dark-gray text-white rounded-full button-text font-medium smooth-transition">5</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-dark-gray text-white rounded-full button-text font-medium smooth-transition">6</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-orange text-white rounded-full button-text font-medium smooth-transition">-</button>

                <!-- Fifth Row: 1 2 3 + -->
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-dark-gray text-white rounded-full button-text font-medium smooth-transition">1</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-dark-gray text-white rounded-full button-text font-medium smooth-transition">2</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-dark-gray text-white rounded-full button-text font-medium smooth-transition">3</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-orange text-white rounded-full button-text font-medium smooth-transition">+</button>

                <!-- Sixth Row: +/- 0 . = -->
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-dark-gray text-white rounded-full text-sm sm:text-base md:text-lg font-medium smooth-transition">+/-</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-dark-gray text-white rounded-full button-text font-medium smooth-transition">0</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-dark-gray text-white rounded-full button-text font-medium smooth-transition">.</button>
                <button
                    class="calc-button h-14 sm:h-16 md:h-18 bg-button-orange text-white rounded-full button-text font-medium smooth-transition">=</button>
            </div>
        </div>

        <!-- Bottom Safe Area (for mobile) -->
        <div class="flex-shrink-0 h-2 sm:h-4 md:h-6"></div>
    </div>

    <script>
        const result = document.getElementById('result');
        const inputExpression = document.getElementById('inputExpression');
        const buttons = document.querySelectorAll('.calc-button');
        const historyModal = document.getElementById('historyModal');
        const historyBtn = document.getElementById('historyBtn');
        console.log('History button found:', historyBtn);
        const closeHistoryBtn = document.getElementById('closeHistoryBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const fullHistoryList = document.getElementById('fullHistoryList');
        
        // Sidebar elements
        const historySidebar = document.getElementById('historySidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const closeSidebarBtn = document.getElementById('closeSidebarBtn');
        const clearSidebarHistoryBtn = document.getElementById('clearSidebarHistoryBtn');
        const sidebarHistoryList = document.getElementById('sidebarHistoryList');
        
        let currentInput = '';
        let calculations = [];
        let shouldResetOnNextNumber = false;
        let lastResult = null;
        let justCalculated = false;
        let isCalculating = false;

        // Function to format input with line breaks every 25 digits
        function formatInputWithLineBreaks(input) {
            if (!input) return '';
            
            // Split the input into parts (numbers and operators)
            const parts = input.split(/([+\-×/*()√])/);
            let formattedParts = [];
            
            for (let part of parts) {
                if (part && !['+', '-', '×', '/', '*', '(', ')', '√'].includes(part)) {
                    // This is a number, add line breaks every 25 digits
                    let formattedNumber = '';
                    for (let i = 0; i < part.length; i++) {
                        if (i > 0 && i % 25 === 0) {
                            formattedNumber += '<br>';
                        }
                        formattedNumber += part[i];
                    }
                    // Keep lines as they are - no padding needed for straight display
                    // Each line will have exactly 25 digits (except the last line)
                    formattedParts.push(formattedNumber);
                } else if (part) {
                    // This is an operator or special character - make it white
                    formattedParts.push(`<span style="color: white;">${part}</span>`);
                }
            }
            
            return formattedParts.join('');
        }

        // Function to format large numbers in scientific notation
        function formatLargeNumber(num) {
            const numStr = num.toString();
            if (numStr.length >= 15) {
                return parseFloat(num).toExponential(6);
            }
            return num;
        }

        // Function to format long numbers for history display
        function formatHistoryNumber(num) {
            if (num === null || num === undefined || num === '') {
                return '';
            }
            const numStr = num.toString();
            if (numStr.length > 15) {
                // Add line breaks every 15 digits
                let formatted = '';
                for (let i = 0; i < numStr.length; i++) {
                    if (i > 0 && i % 15 === 0) {
                        formatted += '\n';
                    }
                    formatted += numStr[i];
                }
                return formatted;
            }
            return numStr;
        }

        // Function to format long numbers with line breaks
        function formatLongNumber(num) {
            const numStr = num.toString();
            if (numStr.length > 25) {
                // Add line breaks every 25 digits
                let formatted = '';
                for (let i = 0; i < numStr.length; i++) {
                    if (i > 0 && i % 25 === 0) {
                        formatted += '\n';
                    }
                    formatted += numStr[i];
                }
                return formatted;
            }
            return numStr;
        }

        // LocalStorage functions
        function saveCalculationsToStorage() {
            try {
                localStorage.setItem('calculatorHistory', JSON.stringify(calculations));
            } catch (error) {
                console.error('Error saving to localStorage:', error);
            }
        }

        function loadCalculationsFromStorage() {
            try {
                const saved = localStorage.getItem('calculatorHistory');
                if (saved) {
                    calculations = JSON.parse(saved);
                    // Clean up old data structure if needed
                    calculations = calculations.filter(calc => calc && (calc.expression || calc.input) && calc.result);
                }
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                calculations = [];
            }
        }

        function clearCalculationsFromStorage() {
            try {
                localStorage.removeItem('calculatorHistory');
            } catch (error) {
                console.error('Error clearing localStorage:', error);
            }
        }

        // Function to format decimal numbers to maximum 6 decimal places
        function formatResult(num) {
            if (typeof num !== 'number' || !isFinite(num)) {
                return num;
            }
            
            // If it's a whole number, return as is (preserve negative sign)
            if (num % 1 === 0) {
                return num;
            }
            
            // For decimal numbers, limit to 6 decimal places and remove trailing zeros
            const formatted = parseFloat(num.toFixed(6));
            return formatted;
        }

        // Function to format result with line breaks every 25 digits
        function formatResultWithLineBreaks(result) {
            if (!result || result === '') return '';
            
            const resultStr = result.toString();
            let formattedResult = '';
            
            for (let i = 0; i < resultStr.length; i++) {
                if (i > 0 && i % 25 === 0) {
                    formattedResult += '<br>';
                }
                formattedResult += resultStr[i];
            }
            
            return formattedResult;
        }

        // Function to format result with white operators
        function formatResultWithWhiteOperators(result) {
            if (result === null || result === undefined || result === '') return '';
            
            const resultStr = result.toString();
            // Don't format negative numbers, just return as is
            return resultStr;
        }

        function updateFullHistoryDisplay() {
            if (calculations.length === 0) {
                fullHistoryList.innerHTML = '<div class="text-gray-400 text-center">No calculations yet</div>';
            } else {
                // Show only the last 3 calculations (most recent first)
                const recentCalculations = calculations.slice(-3).reverse();
                fullHistoryList.innerHTML = recentCalculations.map((calc, index) => {
                    // Handle both old (input) and new (expression) property names
                    const expression = calc.expression || calc.input || '';
                    const result = calc.result || '';
                    const formattedExpression = formatHistoryNumber(expression);
                    const formattedResult = formatHistoryNumber(result);
                    return `<div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700">
                        <div class="text-white font-light text-sm mb-2" style="word-wrap: break-word; white-space: pre-wrap;">${formattedExpression}</div>
                        <div class="text-orange-400 font-medium text-lg" style="word-wrap: break-word; white-space: pre-wrap;">= ${formattedResult}</div>
                        <div class="text-gray-500 text-xs mt-2">Recent calculation ${index + 1}</div>
                    </div>`;
                }).join('');
            }
        }

        function updateSidebarHistoryDisplay() {
            console.log('Calculations array:', calculations);
            if (calculations.length === 0) {
                sidebarHistoryList.innerHTML = '<div class="text-gray-400 text-center">No calculations yet</div>';
            } else {
                // Show only the last 3 calculations (most recent first)
                const recentCalculations = calculations.slice(-3).reverse();
                sidebarHistoryList.innerHTML = recentCalculations.map((calc, index) => {
                    console.log('Processing calc:', calc);
                    // Handle both old (input) and new (expression) property names
                    const expression = calc.expression || calc.input || '';
                    const result = calc.result || '';
                    const formattedExpression = formatHistoryNumber(expression);
                    const formattedResult = formatHistoryNumber(result);
                    return `<div class="bg-gray-800/50 rounded-xl p-4 border border-gray-700 relative">
                        <div class="text-white font-light text-sm mb-2" style="word-wrap: break-word; white-space: pre-wrap;">${formattedExpression}</div>
                        <div class="text-orange-400 font-medium text-lg" style="word-wrap: break-word; white-space: pre-wrap;">= ${formattedResult}</div>
                        <div class="text-gray-500 text-xs mt-2">Recent calculation ${index + 1}</div>
                        <button class="absolute top-2 right-2 text-red-400 hover:text-red-300 transition-colors" onclick="deleteHistoryItem(${calculations.length - 1 - index})">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>`;
                }).join('');
            }
        }

        function deleteHistoryItem(index) {
            if (index >= 0 && index < calculations.length) {
                calculations.splice(index, 1);
                saveCalculationsToStorage();
                updateSidebarHistoryDisplay();
                updateFullHistoryDisplay();
            }
        }

        function isValidInput(current, newValue) {
            if (newValue === '.') {
                const numbers = current.split(/[+\-×/*]/);
                const currentNumber = numbers[numbers.length - 1];
                if (currentNumber.includes('.')) return false;
            }

            if (['+', '-', '×', '/'].includes(newValue)) {
                const lastChar = current.slice(-1);
                if (['+', '-', '×', '/', '*'].includes(lastChar)) return false;
            }

            return true;
        }

        function evaluateExpression(expr) {
            try {
                // Handle square root
                expr = expr.replace(/√(\d+\.?\d*)/g, 'Math.sqrt($1)');
                // Handle implicit multiplication like 5(5+6) -> 5*(5+6)
                expr = expr.replace(/(\d)\(/g, '$1*(');
                expr = expr.replace(/\)(\d)/g, ')*$1');
                expr = expr.replace(/×/g, '*');
                
                const rawResult = eval(expr);
                
                // Handle negative results properly
                if (rawResult === 0) {
                    return 0;
                }
                
                // Return the actual result (preserve negative signs)
                return formatResult(rawResult);
            } catch (error) {
                return 'Error';
            }
        }

        // Function to update input expression display
        function updateInputExpressionDisplay(value) {
            if (value && value.length > 25) {
                // Format long numbers with line breaks
                const formattedValue = formatLongNumber(value);
                inputExpression.innerHTML = formatResultWithWhiteOperators(formattedValue);
                // Auto-scroll to bottom for long content
                setTimeout(() => {
                    const container = inputExpression.parentElement;
                    const scrollHeight = inputExpression.scrollHeight;
                    const containerHeight = container.clientHeight;
                    if (scrollHeight > containerHeight) {
                        const maxScroll = scrollHeight - containerHeight;
                        inputExpression.style.transform = `translateY(-${maxScroll}px)`;
                    }
                }, 10);
            } else {
                inputExpression.innerHTML = formatResultWithWhiteOperators(value);
                inputExpression.style.transform = 'translateY(0)';
            }
        }

        // Function to update result display with line breaks
        function updateResultDisplay(value, isLiveCalculation = false) {
            if (isLiveCalculation && value !== '') {
                const formattedValue = formatLargeNumber(value);
                result.innerHTML = `= ${formatResultWithWhiteOperators(formattedValue)}`;
                result.className = result.className.replace('text-orange-400', 'text-white');
            } else {
                const formattedValue = formatLargeNumber(value);
                result.innerHTML = formatResultWithWhiteOperators(formattedValue);
                result.className = result.className.replace('text-white', 'text-orange-400');
            }
        }

        // Function to dynamically set result font size based on length - using responsive sizing
        function setResultFontSize(value) {
            const len = value.toString().length;
            let fontSize = '';
            if (len <= 7) {
                fontSize = 'clamp(1.8rem, 6vw, 3.5rem)'; // default large
            } else if (len <= 12) {
                fontSize = 'clamp(1.5rem, 5vw, 2.8rem)'; // medium
            } else if (len <= 18) {
                fontSize = 'clamp(1.2rem, 4vw, 2.2rem)'; // small
            } else {
                fontSize = 'clamp(1rem, 3vw, 1.8rem)'; // extra small
            }
            result.style.fontSize = fontSize;
        }

        // Function to control cursor blinking
        function setCursorBlinking(show) {
            if (show) {
                result.classList.add('cursor-blink');
            } else {
                result.classList.remove('cursor-blink');
            }
        }

        // Update updateLiveCalculation to use dual display
        function updateLiveCalculation() {
            try {
                if (currentInput && currentInput !== '') {
                    // Always show current input expression in the top display
                    updateInputExpressionDisplay(currentInput);
                    
                    // Only show live calculation if there's an operator and we're not in the middle of typing a number
                    const hasOperator = /[+\-×/*√]/.test(currentInput);
                    const endsWithOperator = /[+\-×/*√]$/.test(currentInput);

                    if (hasOperator && !endsWithOperator) {
                        const tempResult = evaluateExpression(currentInput);
                        if (tempResult !== 'Error' && !isNaN(tempResult) && isFinite(tempResult)) {
                            updateResultDisplay(tempResult, true); // Live calculation with = sign
                            setResultFontSize(tempResult);
                            lastResult = tempResult;
                            shouldResetOnNextNumber = false;
                        } else {
                            // Clear result display if calculation fails
                            updateResultDisplay('');
                            setResultFontSize('');
                            shouldResetOnNextNumber = false;
                        }
                    } else {
                        // Clear result display if no complete expression
                        updateResultDisplay('');
                        setResultFontSize('');
                        shouldResetOnNextNumber = false;
                    }
                } else {
                    updateInputExpressionDisplay('');
                    updateResultDisplay('');
                    setResultFontSize('');
                    shouldResetOnNextNumber = false;
                }
            } catch {
                updateInputExpressionDisplay('');
                updateResultDisplay('');
                setResultFontSize('');
                shouldResetOnNextNumber = false;
            }
        }

        function isOperator(value) {
            return ['+', '-', '×', '/', '*', '√'].includes(value);
        }

        function isNumber(value) {
            return /^[0-9]$/.test(value);
        }

        function replaceLastOperator(input, newOperator) {
            if (!input) return input;
            const lastChar = input.slice(-1);
            if (isOperator(lastChar)) {
                return input.slice(0, -1) + (newOperator === '×' ? '*' : newOperator);
            }
            return input;
        }

        // Sidebar Event Listeners
        if (historyBtn) {
            console.log('Adding event listener to history button');
            historyBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('History button clicked');
                updateSidebarHistoryDisplay();
                historySidebar.classList.add('open');
                sidebarOverlay.classList.remove('hidden');
                console.log('Sidebar classes:', historySidebar.classList.toString());
            });
        } else {
            console.error('History button not found!');
        }

        closeSidebarBtn.addEventListener('click', () => {
            historySidebar.classList.remove('open');
            sidebarOverlay.classList.add('hidden');
        });

        clearSidebarHistoryBtn.addEventListener('click', () => {
            calculations = [];
            clearCalculationsFromStorage();
            updateSidebarHistoryDisplay();
            updateFullHistoryDisplay();
        });

        sidebarOverlay.addEventListener('click', () => {
            historySidebar.classList.remove('open');
            sidebarOverlay.classList.add('hidden');
        });

        // History Modal Event Listeners
        closeHistoryBtn.addEventListener('click', () => {
            historyModal.classList.add('hidden');
        });

        clearHistoryBtn.addEventListener('click', () => {
            calculations = [];
            clearCalculationsFromStorage();
            updateFullHistoryDisplay();
        });

        // Close modal when clicking outside
        historyModal.addEventListener('click', (e) => {
            if (e.target === historyModal) {
                historyModal.classList.add('hidden');
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (!historyModal.classList.contains('hidden')) {
                historyModal.classList.add('hidden');
                }
                if (historySidebar.classList.contains('open')) {
                    historySidebar.classList.remove('open');
                    sidebarOverlay.classList.add('hidden');
                }
            }
        });

        buttons.forEach(button => {
            // Skip the history button completely - it has its own handler
            if (button.id === 'historyBtn') {
                return;
            }
            
            button.addEventListener('click', () => {
                let actualValue = button.getAttribute('data-value') || button.textContent.trim();

                switch (actualValue) {
                    case 'AC':
                        currentInput = '';
                        inputExpression.textContent = '';
                        result.textContent = '';
                        shouldResetOnNextNumber = false;
                        lastResult = null;
                        justCalculated = false;
                        isCalculating = false;
                        setCursorBlinking(true);
                        updateLiveCalculation();
                        break;

                    case '⌫':
                        if (justCalculated) {
                            currentInput = '';
                            justCalculated = false;
                        } else {
                            currentInput = currentInput.slice(0, -1);
                        }
                        shouldResetOnNextNumber = false;
                        isCalculating = false;
                        setCursorBlinking(true);
                        updateLiveCalculation();
                        break;

                    case '=':
                        try {
                            if (currentInput) {
                                isCalculating = true;
                                setCursorBlinking(false);
                                const finalResult = evaluateExpression(currentInput);
                                if (finalResult !== 'Error' && !isNaN(finalResult) && isFinite(finalResult)) {
                                    calculations.push({
                                        expression: currentInput,
                                        result: finalResult,
                                        timestamp: new Date().toLocaleString()
                                    });
                                    saveCalculationsToStorage();
                                    const formattedResult = formatLargeNumber(finalResult);
                                    updateInputExpressionDisplay(''); // Clear input expression
                                    updateResultDisplay(formattedResult, false); // Final result without = sign
                                    setResultFontSize(formattedResult);
                                    shouldResetOnNextNumber = true;
                                    lastResult = finalResult;
                                    justCalculated = true;
                                } else {
                                    result.textContent = 'Error';
                                    setResultFontSize('Error');
                                    currentInput = '';
                                    shouldResetOnNextNumber = false;
                                    justCalculated = false;
                                    isCalculating = false;
                                    setCursorBlinking(true);
                                }
                            }
                        } catch {
                            result.textContent = 'Error';
                            setResultFontSize('Error');
                            currentInput = '';
                            shouldResetOnNextNumber = false;
                            justCalculated = false;
                            isCalculating = false;
                            setCursorBlinking(true);
                        }
                        break;

                    case '+/-':
                        if (shouldResetOnNextNumber && lastResult !== null) {
                            const negatedResult = formatResult(-lastResult);
                            currentInput = `(${negatedResult})`;
                            // Update display immediately to show the negative number
                            updateResultDisplay(currentInput);
                            setResultFontSize(currentInput);
                            shouldResetOnNextNumber = false;
                            justCalculated = false;
                        } else if (currentInput) {
                            // Handle different cases for +/- button
                            const lastChar = currentInput.slice(-1);
                            
                            // If the last character is a minus sign, remove it (make positive)
                            if (lastChar === '-') {
                                currentInput = currentInput.slice(0, -1);
                                updateResultDisplay(currentInput);
                                setResultFontSize(currentInput);
                            }
                            // If the last character is a plus sign, replace with minus
                            else if (lastChar === '+') {
                                currentInput = currentInput.slice(0, -1) + '-';
                                updateResultDisplay(currentInput);
                                setResultFontSize(currentInput);
                            }
                            // If we have a number at the end, check if it's already negative
                            else {
                                // First check if we have a bracketed negative number like (-6)
                                const bracketedMatch = currentInput.match(/\(-\d+\.?\d*\)$/);
                                if (bracketedMatch) {
                                    // Extract the number from brackets and make it positive
                                    const numberInBrackets = bracketedMatch[0].slice(2, -1); // Remove "(-" and ")"
                                    const newNumber = formatResult(Math.abs(parseFloat(numberInBrackets)));
                                    currentInput = currentInput.replace(/\(-\d+\.?\d*\)$/, newNumber);
                                    // Update display immediately to show the positive number
                                    updateResultDisplay(currentInput);
                                    setResultFontSize(currentInput);
                                } else {
                                    // Check for regular numbers (positive or negative)
                            const lastNumberMatch = currentInput.match(/-?\d+\.?\d*$/);
                            if (lastNumberMatch) {
                                const lastNumber = lastNumberMatch[0];
                                        const numValue = parseFloat(lastNumber);
                                        
                                        // If the number is negative, make it positive (remove brackets if present)
                                        if (numValue < 0) {
                                            const newNumber = formatResult(Math.abs(numValue));
                                            // Remove brackets and minus sign, replace with positive number
                                            currentInput = currentInput.replace(/\(-\d+\.?\d*\)$/, newNumber);
                                            // Update display immediately to show the positive number
                                            updateResultDisplay(currentInput);
                                            setResultFontSize(currentInput);
                                        }
                                        // If the number is positive, make it negative (add brackets)
                                        else {
                                            const newNumber = formatResult(-numValue);
                                currentInput = currentInput.replace(/-?\d+\.?\d*$/, `(${newNumber})`);
                                            // Update display immediately to show the negative number
                                            updateResultDisplay(currentInput);
                                            setResultFontSize(currentInput);
                            }
                        }
                                }
                            }
                        }
                        break;

                    case '%':
                        if (shouldResetOnNextNumber && lastResult !== null) {
                            const percentResult = formatResult(lastResult / 100);
                            currentInput = percentResult.toString();
                            shouldResetOnNextNumber = false;
                            justCalculated = false;
                        } else if (currentInput) {
                            try {
                                const percentResult = formatResult(evaluateExpression(currentInput) / 100);
                                currentInput = percentResult.toString();
                            } catch {
                                result.textContent = 'Error';
                                break;
                            }
                        }
                        updateLiveCalculation();
                        break;

                    case '√':
                        if (shouldResetOnNextNumber && lastResult !== null) {
                            if (lastResult >= 0) {
                                const sqrtResult = formatResult(Math.sqrt(lastResult));
                                currentInput = sqrtResult.toString();
                                shouldResetOnNextNumber = false;
                                justCalculated = false;
                            } else {
                                result.textContent = 'Error';
                                currentInput = '';
                                shouldResetOnNextNumber = false;
                                justCalculated = false;
                            }
                        } else {
                            currentInput += '√';
                            shouldResetOnNextNumber = false;
                            justCalculated = false;
                        }
                        updateLiveCalculation();
                        break;

                    default:
                        if (isOperator(actualValue) && actualValue !== '√') {
                            justCalculated = false;
                            isCalculating = true;
                            setCursorBlinking(false);
                            if (shouldResetOnNextNumber && lastResult !== null) {
                                currentInput = lastResult.toString() + (actualValue === '×' ? '*' : actualValue);
                                shouldResetOnNextNumber = false;
                            } else if (currentInput && !isOperator(currentInput.slice(-1))) {
                                // Check if the last number is negative and needs brackets
                                const lastNumberMatch = currentInput.match(/-?\d+\.?\d*$/);
                                if (lastNumberMatch) {
                                    const lastNumber = lastNumberMatch[0];
                                    const numValue = parseFloat(lastNumber);
                                    if (numValue < 0 && !lastNumber.startsWith('(')) {
                                        // Add brackets around negative number
                                        currentInput = currentInput.replace(/-?\d+\.?\d*$/, `(${lastNumber})`);
                                    }
                                }
                                currentInput += actualValue === '×' ? '*' : actualValue;
                            } else if (currentInput && isOperator(currentInput.slice(-1))) {
                                currentInput = replaceLastOperator(currentInput, actualValue);
                            }
                            updateLiveCalculation();
                        } else if (isNumber(actualValue) || actualValue === '.') {
                            if (shouldResetOnNextNumber || justCalculated) {
                                // Start a new calculation with the new number
                                currentInput = actualValue;
                                shouldResetOnNextNumber = false;
                                justCalculated = false;
                                isCalculating = true;
                                setCursorBlinking(false);
                            } else {
                                if (isValidInput(currentInput, actualValue)) {
                                    currentInput += actualValue;
                                    if (!isCalculating) {
                                        isCalculating = true;
                                        setCursorBlinking(false);
                                    }
                                }
                                shouldResetOnNextNumber = false;
                                justCalculated = false;
                            }
                            updateLiveCalculation();
                        } else {
                            if (shouldResetOnNextNumber && justCalculated) {
                                if (actualValue === '(') {
                                    currentInput = actualValue;
                                    shouldResetOnNextNumber = false;
                                    justCalculated = false;
                                    isCalculating = true;
                                    setCursorBlinking(false);
                                }
                            } else {
                                if (isValidInput(currentInput, actualValue)) {
                                    currentInput += actualValue;
                                    if (!isCalculating) {
                                        isCalculating = true;
                                        setCursorBlinking(false);
                                    }
                                }
                                shouldResetOnNextNumber = false;
                                justCalculated = false;
                            }
                            updateLiveCalculation();
                        }
                        break;
                }
            });
        });

        // Initialize - Load saved calculations on page load
        loadCalculationsFromStorage();
        updateLiveCalculation();
        setCursorBlinking(true);

        // Touch scrolling for input expression
        let isScrolling = false;
        let startY = 0;
        let currentTranslateY = 0;

        inputExpression.addEventListener('touchstart', function(e) {
            isScrolling = true;
            startY = e.touches[0].clientY;
            const currentTransform = inputExpression.style.transform;
            currentTranslateY = parseInt(currentTransform.replace('translateY(', '').replace('px)', '') || 0);
        });

        inputExpression.addEventListener('touchmove', function(e) {
            if (!isScrolling) return;
            
            // Fixed scrolling: swipe down shows first line, swipe up shows last line
            const deltaY = startY - e.touches[0].clientY;
            const newTranslateY = currentTranslateY + deltaY;
            
            const container = inputExpression.parentElement;
            const scrollHeight = inputExpression.scrollHeight;
            const containerHeight = container.clientHeight;
            const maxScroll = Math.max(0, scrollHeight - containerHeight);
            
            // Limit scrolling within bounds
            const limitedTranslateY = Math.max(-maxScroll, Math.min(0, newTranslateY));
            inputExpression.style.transform = `translateY(${limitedTranslateY}px)`;
        });

        inputExpression.addEventListener('touchend', function(e) {
            isScrolling = false;
        });

        // Prevent scrolling on touch devices
        document.addEventListener('touchmove', function(e) {
            e.preventDefault();
        }, { passive: false });

        // Prevent scrolling with mouse wheel
        document.addEventListener('wheel', function(e) {
            e.preventDefault();
        }, { passive: false });

        // Prevent scrolling with keyboard (but allow Escape for modal)
        document.addEventListener('keydown', function(e) {
            if(['Space', 'ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].indexOf(e.code) > -1) {
                e.preventDefault();
            }
        }, false);

        // Prevent exit message on back button
        window.addEventListener('beforeunload', function(e) {
            // Don't show any exit message
            return;
        });

        // Prevent back button exit message (for mobile browsers)
        window.addEventListener('popstate', function(e) {
            // Prevent the default back button behavior
            history.pushState(null, null, window.location.href);
        });

        // Push initial state to prevent back button issues
        history.pushState(null, null, window.location.href);
    </script>
</body>

</html>


